# nginxå¸¸è§é—®é¢˜

## nginx location åŠ æ–œæ å’Œä¸åŠ æ–œæ 

åŒºåˆ«åœ¨äºæ˜¯å¦åŒ¹é…å­è·¯å¾„

### location /users

 ä¼šåŒ¹é…æ‰€æœ‰ä»¥ `/users` å¼€å¤´çš„è·¯å¾„ï¼Œä½†ä¸ä¼šåŒ¹é…/usersæœ¬èº«ï¼Œæ¯”å¦‚

```sh
#ä¸ä¼šåŒ¹é…
/users 
# ä¼šåŒ¹é…
/usersxxx
/users/
/users/xxx
```

### location /users/ 

ä¼šåŒ¹é…æ‰€æœ‰ä»¥ `/users/` å¼€å¤´çš„è·¯å¾„ï¼ŒåŒ…æ‹¬ `/users/` æœ¬èº«ã€‚ä¾‹å¦‚ï¼Œå®ƒä¼šåŒ¹é…`/users/` ã€`/users/foo/`ã€`/users/bar/` ï¼Œä¸ä¼šåŒ¹é…/usersxxx

```sh
#ä¸ä¼šåŒ¹é…
/users
/usersxxx
# ä¼šåŒ¹é…
/users/
/users/xxx
```



## proxy_pass

æˆ‘ä»¬èµ·çš„æœåŠ¡ä¸º1024ç«¯å£ï¼Œè®¾ç½®nginxä»£ç†åˆ°9001ç«¯å£ï¼Œ9001ç«¯å£èµ·ä¸€ä¸ªserverï¼Œ

è®¿é—®http://127.0.0.1:9001/users/123.txtå¯ä»¥è®¿é—®åˆ°æ–‡ä»¶

### proxy_pass ä¸åŠ æ–œæ 

å¦‚æœ `proxy_pass` åä¸å¸¦ `/`ï¼ŒNginx ä¼šå°†**åŒ¹é…çš„ location URI éƒ¨åˆ†**ç›´æ¥æ›¿æ¢ä¸º `proxy_pass` æŒ‡å®šçš„ URLï¼Œè€Œä¸ä¼šä¿ç•™åŒ¹é…çš„éƒ¨åˆ†ã€‚

```nginx
location /images/ {
    proxy_pass http://127.0.0.1:30008;
}
```

æˆ‘ä»¬è®¿é—® http://localhost:27001/images/data.pngï¼Œå®é™…è®¿é—®ä»£ç†åœ°å€ï¼šhttp://127.0.0.1:30008/images/data.png

```nginx
location /images/ {
    proxy_pass http://127.0.0.1:30008/images;
}
```

è®¿é—®http://localhost:27001/images/data.pngï¼Œå®é™…è®¿é—®åœ°å€ï¼šhttp://127.0.0.1:30008/app/data.png

å¦‚æœä½ å¸Œæœ› `/images/` ç›´æ¥æ˜ å°„åˆ° `/app/images/`ï¼Œä½ éœ€è¦æ”¹æˆï¼š

```nginx
location /images/ {
    proxy_pass http://127.0.0.1:9001/app/images/;
}
```

è¿™æ · `http://localhost:1024/users/123.txt` ä¼šå˜æˆ `http://127.0.0.1:9001/app/users/123.txt`ã€‚

### proxy_pass åŠ æ–œæ 

å¦‚æœ `proxy_pass` åå¸¦æœ‰ `/`ï¼ŒNginx ä¼š **ç§»é™¤åŒ¹é…éƒ¨åˆ†**ï¼Œç„¶åå°†å‰©ä½™çš„ URI è¿½åŠ åˆ° `proxy_pass` æŒ‡å®šçš„ URLã€‚

```nginx
location /pictures/ {
    proxy_pass http://127.0.0.1:30008/;
}
```

æˆ‘ä»¬è®¿é—® http://localhost:27001/pictures/dora.pngï¼Œå®é™…è®¿é—®ä»£ç†åœ°å€ï¼šhttp://127.0.0.1:30008/dora.png


```nginx
location /pictures/ {
    proxy_pass http://127.0.0.1:30008/pictures/;
}
```

è®¿é—®http://localhost:27001/pictures/dora.pngï¼Œå®é™…è®¿é—®åœ°å€ï¼šhttp://127.0.0.1:30008/pictures/dora.png

æ€»ç»“ï¼Œproxy_passæ²¡æœ‰æ–œæ ï¼Œåˆ™åªæ›¿æ¢ipå’Œç«¯å£éƒ¨åˆ†ï¼Œæœ‰æ–œæ åˆ™å°†åŒ¹é…éƒ¨åˆ†åçš„å€¼æ‹¼æ¥åˆ°proxy_passä¸Š

ğŸ“Œ **è®°å¿†æ–¹æ³•**ï¼š

- **`proxy_pass` ä¸åŠ  `/`** â†’ **åŸæ ·è½¬å‘è·¯å¾„**
- **`proxy_pass` åŠ  `/`** â†’ **å»æ‰ `location` åŒ¹é…çš„éƒ¨åˆ†**



## rootå’Œaliasçš„åŒºåˆ«

locationå†…å†™root

æœ€ç»ˆçš„æ–‡ä»¶è·¯å¾„æ˜¯å°† `root` æŒ‡å®šçš„è·¯å¾„ä¸è¯·æ±‚çš„ URI æ‹¼æ¥èµ·æ¥

```nginx
server {
    root /var/www; # å…¨å±€ root

    location /app/ {
        root /opt/homebrew/var/reactrouter/dist;
    }
}
```



```nginx
server {
    listen 30008;
    server_name localhost;
    # root /opt/homebrew/var/web;
    # ä½¿ç”¨ root æŒ‡ä»¤
    location /images/ {
        root /opt/homebrew/var/web/;
    }
    # ä½¿ç”¨ alias æŒ‡ä»¤
    location /pictures/ {
        alias /opt/homebrew/var/web/pictures/;
    }
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

- è¯·æ±‚ http://localhost:30008/images/data.pngï¼ŒåŒ¹é… /images/ï¼Œrootä¼šæ‹¼ä¸Š /images/data.pngï¼Œå°†æ˜ å°„åˆ° /opt/homebrew/var/web/images/data.png
- è¯·æ±‚ http://localhost:30008/pictures/dora.pngï¼ŒåŒ¹é… /pictures/ï¼Œaliasä¼šæ›¿æ¢æ‰locationçš„å€¼ï¼Œå°†æ˜ å°„åˆ° /opt/homebrew/var/web/pictures/dora.png

å¦‚æœå°†ä¸Šé¢çš„aliasè°ƒæ•´ä¸ºalias /opt/homebrew/var/web/picturesï¼Œä¸ä»¥ / ç»“å°¾ï¼Œåˆ™è¿”å›404

==æ‰€ä»¥aliasè¦ä»¥ / ç»“å°¾==

ä¸¾ä¾‹ï¼š

```nginx
location /skybox-aicc-portal/ {
    root /Users/cheng/iFly/ZGH/zs-portal-zgh/;
    try_files $uri $uri/ /skybox-aicc-portal/index.html;
}
# ä»£ç†é™æ€èµ„æºï¼Œé˜²æ­¢ 404
location /skybox-aicc-portal/ {
    alias /Users/cheng/iFly/ZGH/zs-portal-zgh/skybox-aicc-portal/;
}
```

è¿™é‡Œä¸¤ä¸ªé…ç½®æ•ˆæœç›¸åŒ



**`root` ä¸ `alias`**ï¼šå½“ä½¿ç”¨ `root` æ—¶ï¼ŒNginx ä¼šå°† URI å’Œ `root` æ‹¼æ¥èµ·æ¥ã€‚è€Œä½¿ç”¨ `alias` æ—¶ï¼ŒNginx ä¼šå°†è¯·æ±‚çš„è·¯å¾„æ›¿æ¢æˆ `alias` æŒ‡å®šçš„ç›®å½•ï¼Œé¿å…è·¯å¾„æ‹¼æ¥é”™è¯¯ã€‚

```nginx
# æœ€ç»ˆè®¿é—®çš„è·¯å¾„æ˜¯/opt/homebrew/var/web/router/dist/app/
location /app/ {
    root /opt/homebrew/var/web/router/dist/;
    expires 1h;
    try_files $uri $uri/ /index.html;
}
```



åœ¨ä½¿ç”¨ `alias` æ—¶ï¼Œè·¯å¾„çš„å®é™…è§£æä¼šä» `alias` å¼€å§‹æ›¿æ¢ï¼Œæ‰€ä»¥ `try_files` çš„ `$uri` ä¼šæ˜ å°„åˆ° `alias` çš„è·¯å¾„ï¼Œè€Œä¸æ˜¯ `root` çš„è·¯å¾„ã€‚

æˆ‘ä»¬ä»¥è¿™ä¸ªé…ç½®ä¸ºä¾‹

```nginx
server {
  listen 20003;
  server_name localhost;
  root /opt/homebrew/var/web;

  location /vue-app/ {
    alias /opt/homebrew/var/web/vue-app/dist/;
    expires 1h;
    try_files $uri $uri/ /index.html;
    error_page 404 /index.html;
  }
```

åœ¨ `location /vue-app/` ä¸­ï¼Œ`alias` ä¼šæ›¿æ¢æ‰åŒ¹é…çš„ `location` å‰ç¼€ï¼Œå› æ­¤ï¼š

- è¯·æ±‚è·¯å¾„ `/vue-app/home` å®é™…ä¼šè§£æä¸º /opt/homebrew/var/web/vue-app/dist/homeã€‚
- è¯·æ±‚è·¯å¾„ `/vue-app/` å®é™…ä¼šè§£æä¸º `/opt/homebrew/var/web/vue-app/dist/`ã€‚

å½“ä½¿ç”¨ `try_files $uri $uri/ /index.html` æ—¶ï¼š

- `$uri` æ˜¯ `/vue-app/home`ï¼Œå› æ­¤ä¼šæŸ¥æ‰¾ `/opt/homebrew/var/web/vue-app/dist/vue-app/home`ï¼ˆæ— æ•ˆï¼‰ã€‚
- `$uri/` æ˜¯ `/vue-app/home/`ï¼Œå› æ­¤ä¼šæŸ¥æ‰¾ `/opt/homebrew/var/web/vue-app/dist/vue-app/home/`ï¼ˆæ— æ•ˆï¼‰ã€‚
- å›é€€åˆ° `/index.html` æ—¶ï¼Œå®ƒä¼šè§£æä¸º `/opt/homebrew/var/web/index.html`ï¼Œè€Œä¸æ˜¯æœŸæœ›çš„ `/opt/homebrew/var/web/vue-app/dist/index.html`ã€‚

**é—®é¢˜åŸå› ï¼š**

- é»˜è®¤ `/index.html` æ˜¯åŸºäº `root` çš„è·¯å¾„ï¼Œè€Œä½ çš„é™æ€æ–‡ä»¶åœ¨ `alias` æŒ‡å®šçš„ç›®å½•ä¸‹ï¼Œæ‰€ä»¥è·¯å¾„ä¸åŒ¹é…ã€‚

### try_files $uri $uri/ /vue-app/index.html;ä¸­çš„/vue-app/æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ

> åœ¨ `try_files $uri $uri/ /vue-app/index.html;` è¿™è¡Œé…ç½®ä¸­,/vue-app/æ˜¯æŒ‡æµè§ˆå™¨urlä¸­çš„è·¯å¾„è¿˜æ˜¯æŒ‡èµ„æºæ–‡ä»¶åœ¨æœåŠ¡å™¨ä¸Šçš„è·¯å¾„?

`/vue-app/index.html` æŒ‡çš„æ˜¯ **æµè§ˆå™¨ URL è·¯å¾„**ï¼Œè€Œä¸æ˜¯æœåŠ¡å™¨ä¸Šçš„å®é™…æ–‡ä»¶è·¯å¾„ã€‚

å¦‚ä½•ç†è§£`try_files $uri $uri/ /vue-app/index.html;`å‘¢ï¼Œå³å…ˆæ‰¾$uriï¼Œå†æ‰¾$uri/ï¼Œæ‰¾ä¸åˆ°æœ€ç»ˆå†æŸ¥æ‰¾/vue-app/index.htmlï¼Œä¹Ÿå°±æ˜¯åŒ¹é…/vue-app/è§„åˆ™

## aliaså¸¦æ–œæ å’Œä¸å¸¦æ–œæ 

```nginx
server {
    listen 80;
    server_name example.com;

    # å¸¦æ–œæ çš„ alias
    location /pictures/ {
        alias /var/www/html/images/;
    }

    # ä¸å¸¦æ–œæ çš„ alias
    location /photos/ {
        alias /var/www/html/images;
    }
}
```

- è®¿é—® `http://example.com/pictures/picture.jpg` å°†æ˜ å°„åˆ° `/var/www/html/images/picture.jpg`ã€‚
- è®¿é—® `http://example.com/photos/picture.jpg` å°†æ˜ å°„åˆ° `/var/www/html/images/photos/picture.jpg`ã€‚

### è§£é‡Š

- **å¸¦æ–œæ çš„ `alias`**ï¼šåªæ›¿æ¢ `location` åŒ¹é…åˆ°çš„éƒ¨åˆ†ï¼Œä¸ä¼šæ·»åŠ é¢å¤–çš„æ–œæ ï¼Œè·¯å¾„ç›´æ¥è¿æ¥ã€‚
- **ä¸å¸¦æ–œæ çš„ `alias`**ï¼šåœ¨ `alias` è·¯å¾„å’Œè¯·æ±‚çš„ URI éƒ¨åˆ†ä¹‹é—´æ·»åŠ ä¸€ä¸ªæ–œæ ï¼Œç»“æœæ˜¯è·¯å¾„è¿æ¥ã€‚



## return å’Œrewriteé‡å®šå‘

```nginx
location / {
    return 301 /app/;
}

location / {
    rewrite ^/$ /app/ permanent;
}
```

return 301 å’Œ rewrite éƒ½å¯ä»¥å®ç°é‡å®šå‘

return 301é€‚ç”¨äºç®€å•çš„é‡å®šå‘ï¼Œä¸éœ€è¦è¿›ä¸€æ­¥ä¿®æ”¹ URL è·¯å¾„ã€‚



## ä½¿ç”¨302 Locationè¿›è¡Œé‡å®šå‘



