## Reactç»„ä»¶ç¼“å­˜åŠæ¸²æŸ“ä¼˜åŒ–

- reactç»„ä»¶æ›´æ–°æ˜¯è‡ªä¸Šè€Œä¸‹çš„ï¼Œå³å…ˆçˆ¶åå­

- è€Œvueç»„ä»¶æ›´æ–°ï¼Œç”Ÿå‘½å‘¨æœŸåˆ™æ˜¯å…ˆå­åçˆ¶



å‚è€ƒï¼š[https://segmentfault.com/a/1190000025138329](https://segmentfault.com/a/1190000025138329)

æˆ‘ä»¬éƒ½çŸ¥é“å½“ç»„ä»¶propså’Œstateå‘ç”Ÿæ”¹å˜æ—¶ï¼Œå½“å‰ç»„ä»¶ä»¥åŠå…¶å­å­™ç»„ä»¶ä¼šé‡æ–°æ¸²æŸ“ï¼Œä½†æ˜¯æœ‰ä¸€äº›ç»„ä»¶ï¼ˆçº¯æ–‡æœ¬ç»„ä»¶ï¼‰æ˜¯ä¸éœ€è¦é‡æ–°æ¸²æŸ“çš„ï¼Œè¿™ç§ä¸éœ€è¦çš„ç»„ä»¶è¢«é‡æ–°æ¸²æŸ“ä¼šå½±å“æ•´ä½“çš„æ¸²æŸ“æ€§èƒ½ã€‚

React.memo()å’ŒPureComponentå¾ˆç›¸ä¼¼ï¼Œéƒ½æ˜¯ç”¨æ¥æ§åˆ¶ç»„ä»¶ä½•æ—¶æ¸²æŸ“çš„ã€‚

é€šè¿‡æ§åˆ¶ç»„ä»¶ä½•æ—¶æ¸²æŸ“å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨Reactä¸­å¯ä»¥ç”¨æ¥ä¼˜åŒ–ç»„ä»¶æ€§èƒ½çš„æ–¹æ³•å¤§æ¦‚æœ‰ä»¥ä¸‹å‡ ç§:

- ç»„ä»¶æ‡’åŠ è½½(React.lazy(...)å’Œ\<Suspense />)
- PureComponent
- shouldComponentUpdate(...){...}ç”Ÿå‘½å‘¨æœŸå‡½æ•°
- React.memo

```tsx
// Parent.tsx
import React,Â { useState } from 'react';
import Child from '../Child';

const Parent =Â () => {
 const [count, setCount]Â = useState(0);
 console.log('parentÂ renderÂ update')
 return (
     <React.Fragment>
         <div>{count}</div>
         <button onClick={() => setCount(count + 1)}>++++</button>
         <Child msg='test'/>
     </React.Fragment>
 )
}

export default Parent;
```

```tsx
// Child.tsx
import React from 'react';

const Child =Â (props) => {
 console.log('child renderÂ update');
 return <div>{props.msg}</div>
}

export default Child;
```

å½“çˆ¶ç»„ä»¶æ”¹å˜stateæ—¶ï¼ŒChildç»„ä»¶ä¹Ÿé‡æ–°æ¸²æŸ“äº†

è€Œåœ¨Vue3ä¸­ï¼Œè¿™ç§æƒ…å†µä¸ä¼šå‡ºç°ã€‚vue3å·²ç»å¯¹è¯¥æƒ…å†µä¼˜åŒ–è¿‡äº†ã€‚



```jsx
const MyComponent = React.memo(function MyComponent(props) {
  /* render using props */
});
```

## React.memo

`React.memo`æ˜¯ä¸€ä¸ª[é«˜é˜¶ç»„ä»¶](https://reactjs.org/docs/higher-order-components.html)ã€‚åŠŸèƒ½ä¸class component ä¸­çš„PureComponent ç±»ä¼¼

```jsx
import React, { memo, useState } from "react";

export default function Main() {
  const [number, setNumber] = useState(0);
  const [count, setCount] = useState(0);
  console.log("çˆ¶ç»„ä»¶ render");
  return (
    <>
      <span>{count}</span>
      <button
        onClick={() => {
          setCount(count + 1);
        }}
      >
        btn
      </button>
      <BaseButton number={number} setNumber={setNumber} />
    </>
  );
}

const BaseButton = memo(({ number, setNumber }) => {
  console.log("----å­ç»„ä»¶é‡æ–°æ¸²æŸ“----");
  return (
    <>
      <button onClick={() => setNumber(number + 1)}>{number}</button>
    </>
  );
});
```

ä½¿ç”¨memoåŒ…è£¹å­ç»„ä»¶æ—¶ï¼Œ**åªæœ‰propså‘ç”Ÿæ”¹å˜å­ç»„ä»¶æ‰ä¼šé‡æ–°æ¸²æŸ“**ï¼Œä»¥æå‡ä¸€å®šçš„æ€§èƒ½ã€‚

è¿™é‡Œä½¿ç”¨memoåBaseButtonåªæœ‰åœ¨numberå‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡æ–°æ¸²æŸ“ã€‚

å¯ä»¥é€šè¿‡è§‚å¯Ÿdomç»“æ„çš„åˆ·æ–°æ¥åˆ¤æ–­æ˜¯å¦æ¸²æŸ“ğŸ‘‡

<img src="https://minimax-1256590847.cos.ap-shanghai.myqcloud.com/img/image-20230521213412278.png" alt="image-20230521213412278" style="zoom:50%;" />

ä½†æ˜¯æŠŠBaseButtonæ”¾åˆ°Mainçˆ¶ç»„ä»¶å†…åï¼Œæ¯æ¬¡çˆ¶ç»„ä»¶æ›´æ–°ï¼Œå­ç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“ï¼Œè¿™ç§æƒ…å†µä¸‹å°±éœ€è¦useMemoäº†

```jsx
import React, { memo, useState } from "react";

export default function Main() {
  const [number, setNumber] = useState(0);
  const [count, setCount] = useState(0);
  const BaseButton = memo(({ number, setNumber }) => {
    console.log("----å­ç»„ä»¶é‡æ–°æ¸²æŸ“----");
    return (
      <>
        <button onClick={() => setNumber(number + 1)}>{number}</button>
      </>
    );
  });
  console.log("çˆ¶ç»„ä»¶ render");
  return (
    <>
      <span>{count}</span>
      <button
        onClick={() => {
          setCount(count + 1);
        }}
      >
        btn
      </button>
      <BaseButton number={number} setNumber={setNumber} />
    </>
  );
}
```



<img src="https://minimax-1256590847.cos.ap-shanghai.myqcloud.com/img/image-20230521213820097.png" alt="image-20230521213820097" style="zoom:50%;" />

### ç¬¬äºŒä¸ªå‚æ•°

ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›trueï¼Œä¸ä¼šè§¦å‘renderï¼Œè¿”å›falseåˆ™ä¼š

```ts
propsAreEqual?: (prevProps: Readonly<P>, nextProps: Readonly<P>) => boolean
```





## useMemo

`useMemo()` åŸºæœ¬ç”¨æ³•å¦‚ä¸‹ï¼š

```text
const memoizedValue = useMemo(() => computeExpensiveValue(a, b), [a, b]);
```

useMemo() è¿”å›çš„æ˜¯ä¸€ä¸ª memoized å€¼ï¼Œåªæœ‰å½“ä¾èµ–é¡¹ï¼ˆæ¯”å¦‚ä¸Šé¢çš„ a,b å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæ‰ä¼šé‡æ–°è®¡ç®—è¿™ä¸ª memoized å€¼ï¼‰

memoized å€¼ä¸å˜çš„æƒ…å†µä¸‹ï¼Œä¸ä¼šé‡æ–°è§¦å‘æ¸²æŸ“é€»è¾‘ã€‚

useMemo æ˜¯åœ¨ render æœŸé—´æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ä¸èƒ½è¿›è¡Œä¸€äº›é¢å¤–çš„å‰¯æ“ä½œï¼Œæ¯”å¦‚ç½‘ç»œè¯·æ±‚ç­‰ã€‚

**useMemoç¬¬äºŒä¸ªå‚æ•°**

- ç©ºæ•°ç»„

  ä»…è®¡ç®—ä¸€æ¬¡ï¼Œå³ç»„ä»¶åŠ è½½çš„æ—¶å€™

- ä¸ä¼ 

  > If no array is provided, a new value will be computed on every render.

  å¦‚æœæ²¡æœ‰æä¾›ä¾èµ–æ•°ç»„ï¼ˆä¸Šé¢çš„ [a,b]ï¼‰åˆ™æ¯æ¬¡éƒ½ä¼šé‡æ–°è®¡ç®— memoized å€¼ï¼Œä¹Ÿå°±ä¼š re-redner



**é¦–å…ˆæ˜¯ä¸ä½¿ç”¨ä»»ä½•ä¼˜åŒ–æ–¹æ³•**

```jsx
import React, { useState } from "react";

export default function Main() {
  const [number, setNumber] = useState(0);
  const handleClick = () => setNumber(number + 1);

  const BaseButton = () => {
    console.log("----å­ç»„ä»¶é‡æ–°æ¸²æŸ“----");
    return (
      <>
        <button onClick={() => setNumber(number+1)}>{number}</button>
      </>
    );
  };

  return (
    <>
      <span>{number}</span>
      <button onClick={handleClick}>btn</button>
      <BaseButton />
    </>
  );
}
```

è¿™ç§æƒ…å†µï¼Œç‚¹å‡»btnå¯ä»¥çœ‹åˆ°æ•´ä¸ªMainç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“ã€‚

<img src="https://minimax-1256590847.cos.ap-shanghai.myqcloud.com/img/20221110095445.png"/>

**è€Œå¦‚æœå°†BaseButtonå†™åœ¨å¤–é¢**

```jsx
import React, { useState } from "react";

export default function Main() {
  const [number, setNumber] = useState(0);
  const handleClick = () => setNumber(number + 1);

  return (
    <>
      <span>{number}</span>
      <button onClick={handleClick}>btn</button>
      <BaseButton mykey={"1312321"} name={"zs"} />
    </>
  );
}

const BaseButton = (props) => {
  console.log("----å­ç»„ä»¶é‡æ–°æ¸²æŸ“----", props);
  return (
    <>
      <button>BaseButton</button>
      <span>{props.mykey}</span>
    </>
  );
};
```

è™½ç„¶ä¹Ÿä¼šæ‰“å°----å­ç»„ä»¶é‡æ–°æ¸²æŸ“----

ä½†æ˜¯domæ˜¯ä¸ä¼šåŠ¨çš„

ä½†æ˜¯å¯ä»¥çœ‹åˆ°åªæœ‰span è‡ªå·±æ¸²æŸ“äº†

<img src="https://minimax-1256590847.cos.ap-shanghai.myqcloud.com/img/20221110095554.png"/>

**æ¥ç€æˆ‘ä»¬å†ä½¿ç”¨useMemo**

```jsx
import React, { useMemo, useState } from "react";

export default function Main() {
  const [number, setNumber] = useState(0);

  const BaseButton = useMemo(() => {
    console.log("----å­ç»„ä»¶é‡æ–°æ¸²æŸ“----");
    return (
      <>
        <button onClick={() => setNumber(number + 1)}>{number}</button>
      </>
    );
  }, [number]);

  return (
    <>
      <span>{number}</span>
      <button onClick={() => setNumber(number + 1)}>btn</button>
      {BaseButton}
    </>
  );
}
```



[codesandbox](https://codesandbox.io/s/react-memo-usememo-clqls)

<iframe src="https://codesandbox.io/embed/react-memo-usememo-clqls?fontsize=14&hidenavigation=1&theme=dark"
     style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
     title="react-memo&amp;useMemo"
     allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
     sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
   ></iframe>

## useCallback

ç®€å•ç†è§£å‘¢ useCallback ä¸ useMemo ä¸€ä¸ªç¼“å­˜çš„æ˜¯å‡½æ•°ï¼Œä¸€ä¸ªç¼“å­˜çš„æ˜¯å‡½æ•°çš„è¿”å›å€¼ã€‚

æ‰€ä»¥è¢«useCallbackåŒ…è£¹çš„ç»„ä»¶ï¼Œåœ¨ä½¿ç”¨æ—¶å¯ä»¥å½“æˆæ ‡ç­¾æ¥ä½¿ç”¨

```tsx
const Child = useCallback(()=> {
  //...
})
return (
  <Child />
)
```

useCallbackä¼šå¯¼è‡´çˆ¶ç»„ä»¶re-render

## diffç®—æ³•

react 16 ä¹‹å‰çš„ diffï¼šhttps://www.cnblogs.com/forcheng/p/13246874.html

Fiber: https://zhuanlan.zhihu.com/p/26027085

React é€šè¿‡å¤§èƒ†çš„å‡è®¾ï¼Œå¹¶åŸºäºå‡è®¾æå‡ºç›¸å…³ç­–ç•¥ï¼ŒæˆåŠŸçš„å°† O(n^3) å¤æ‚åº¦çš„é—®é¢˜è½¬åŒ–ä¸º O(n) å¤æ‚åº¦çš„é—®é¢˜ã€‚



### diffä¼˜åŒ–

- tree diff
- Component diff
- Element diff



#### Tree diff

React åªå¯¹è™šæ‹Ÿ DOM æ ‘è¿›è¡Œåˆ†å±‚æ¯”è¾ƒï¼Œä¸è€ƒè™‘èŠ‚ç‚¹çš„è·¨å±‚çº§æ¯”è¾ƒã€‚



## Reactç»„ä»¶æ‡’åŠ è½½

åœ¨ React ä¸­å¼‚æ­¥åŠ è½½ç»„ä»¶å¯ä»¥é‡‡ç”¨ä¸¤ç§æ–¹å¼ï¼šä½¿ç”¨import()å‡½æ•°æˆ–è€…ä½¿ç”¨React.lazy

**1. ä½¿ç”¨React.lazyï¼š**

```tsx
import { lazy, Suspense } from 'react';

const AsyncComponent = lazy(() => import('./AsyncComponent'));

function App() {
  return (
    <div>
      <Suspense fallback={<div>Loading...</div>}>
        <AsyncComponent />
      </Suspense>
    </div>
  );
}
```
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨React.lazyæ—¶ï¼Œåªèƒ½ç”¨åœ¨é»˜è®¤å¯¼å‡ºçš„ç»„ä»¶ä¸Š

**2. ä½¿ç”¨import()å‡½æ•°ï¼š**

```tsx
import { useState, useEffect } from 'react';

function App() {
  const [AsyncComponent, setAsyncComponent] = useState(null);

  useEffect(() => {
    // å¼‚æ­¥åŠ è½½ç»„ä»¶
    import('./AsyncComponent').then((module) => {
      setAsyncComponent(module.default);
    });
  }, []);

  if (!AsyncComponent) {
    return <div>Loading...</div>;
  }

  return <AsyncComponent />;
}
```

> React16.6.0 ç‰ˆæœ¬å¼€å§‹ï¼ŒReact åŸç”Ÿæä¾›äº† code-splitting ä¸ç»„ä»¶åŠ¨æ€åŠ è½½çš„æ–¹æ¡ˆï¼Œå¼•å…¥äº† lazy å‡½æ•°ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒä½¿ç”¨ Suspense ä¸ ErrorBoundary æ¥è¿›è¡Œå¼‚å¸¸å¤„ç†ä¸ fallback å±•ç¤ºã€‚

æ‰€ä»¥æˆ‘ä»¬åœ¨Reactä¸­ä½¿ç”¨lazyå’Œimport()åŠ è½½å¼‚æ­¥ç»„ä»¶åï¼Œç»„ä»¶é»˜è®¤å°±æ˜¯splitè¿‡çš„ï¼Œchunkåå°±æ˜¯ç»„ä»¶æ–‡ä»¶å