# Markdownä¸­æ•°å­¦å…¬å¼çš„æ¸²æŸ“

æ¥çœ‹ä¸€æ®µGPTè¿”å›çš„æ–‡æœ¬

```txt
**æ¬§æ‹‰å…¬å¼**ï¼ˆEuler's Formulaï¼‰æ˜¯å¤åˆ†æå’Œå¤æ•°ç†è®ºä¸­çš„ä¸€ä¸ªåŸºç¡€å…¬å¼ï¼Œå®ƒå°†å¤æŒ‡æ•°å‡½æ•°ä¸ä¸‰è§’å‡½æ•°ä¹‹é—´å»ºç«‹äº†è”ç³»ã€‚å…¶å½¢å¼ä¸ºï¼š\n\n\\[\ne^{ix} = \\cos(x) + i \\sin(x)\n\\]\n\nå…¶ä¸­ï¼š\n- \\( e \\) æ˜¯è‡ªç„¶å¯¹æ•°çš„åº•æ•°ï¼Œçº¦ç­‰äº 2.71828ã€‚\n- \\( i \\) æ˜¯è™šæ•°å•ä½ï¼Œæ»¡è¶³ \\( i^2 = -1 \\)ã€‚\n- \\( x \\) æ˜¯å®æ•°ã€‚\n\n### æ¬§æ‹‰å…¬å¼çš„å«ä¹‰\næ¬§æ‹‰å…¬å¼æ­ç¤ºäº†å¤æ•°æŒ‡æ•°å½¢å¼å’Œä¸‰è§’å‡½æ•°çš„å…³ç³»ã€‚ç‰¹åˆ«åœ°ï¼š\n- \\( \\cos(x) \\) æ˜¯å¤æŒ‡æ•°å‡½æ•°çš„**å®éƒ¨**ã€‚\n- \\( \\sin(x) \\) æ˜¯å¤æŒ‡æ•°å‡½æ•°çš„**è™šéƒ¨**ã€‚\n\n### æ¬§æ‹‰å…¬å¼çš„æ¨å¯¼\n\næ¬§æ‹‰å…¬å¼çš„æ¨å¯¼é€šå¸¸æ˜¯é€šè¿‡çº§æ•°å±•å¼€ã€‚é¦–å…ˆï¼Œè€ƒè™‘è‡ªç„¶æŒ‡æ•°å‡½æ•°ã€ä½™å¼¦å‡½æ•°å’Œæ­£å¼¦å‡½æ•°çš„æ³°å‹’çº§æ•°å±•å¼€ï¼š\n\n- **è‡ªç„¶æŒ‡æ•°å‡½æ•°** \\( e^x \\) çš„æ³°å‹’çº§æ•°ï¼š\n  \\[\n  e^x = 1 + x + \\frac{x^2}{2!} + \\frac{x^3}{3!} + \\frac{x^4}{4!} + \\dots\n  \\]\n\n- **ä½™å¼¦å‡½æ•°** \\( \\cos(x) \\) çš„æ³°å‹’çº§æ•°...
```

å…¶ä¸­Katexä¸æ”¯æŒ `\[`å’Œ `\]` ï¼Œå®ƒåªæ”¯æŒ `$$` æˆ–ç›´æ¥ä½¿ç”¨ `\\(` å’Œ `\\)` æ¥åŒ…å›´è¡Œå†…å…¬å¼

é‚£ä¹ˆChatGPTä¸ºä»€ä¹ˆä¸ç›´æ¥è¿”å›è½¬æ¢ä¸ºæ¸²æŸ“åçš„ HTML æˆ– KaTeX æ”¯æŒçš„æ ¼å¼å‘¢ã€‚

å› ä¸º ChatGPT æœ¬èº«å¹¶ä¸æ‰§è¡Œ KaTeX æ¸²æŸ“æ“ä½œï¼Œå®ƒåªæ˜¯ç”ŸæˆåŸå§‹çš„ LaTeX ä»£ç æˆ–æ•°å­¦è¡¨è¾¾å¼ã€‚

- **LaTeX è¡¨è¾¾å¼**ï¼šChatGPT ä¼šç›´æ¥è¿”å›ç¬¦åˆ LaTeX è¯­æ³•çš„æ–‡æœ¬ã€‚è¿™å¯¹äºæ•°å­¦å…¬å¼çš„è¡¨ç¤ºéå¸¸æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯ç”¨äºç§‘å­¦å’Œæ•°å­¦é¢†åŸŸï¼Œä½†å®ƒå¹¶ä¸è‡ªåŠ¨å°†å…¶æ¸²æŸ“æˆ HTML æˆ–å…¶ä»–å¯è§†åŒ–æ ¼å¼ï¼Œå› ä¸ºå®ƒçš„è¾“å‡ºæ˜¯çº¯æ–‡æœ¬ã€‚

- **KaTeX æ¸²æŸ“**ï¼šKaTeX æ˜¯ä¸€ä¸ª JavaScript åº“ï¼Œç”¨äºåœ¨æµè§ˆå™¨ä¸­æ¸²æŸ“ LaTeX å…¬å¼ã€‚å®ƒå¹¶ä¸ä¼šè‡ªåŠ¨å°†åŸå§‹ LaTeX ä»£ç è½¬æ¢ä¸º HTMLï¼Œè€Œæ˜¯éœ€è¦åœ¨å‰ç«¯é€šè¿‡ç‰¹å®šçš„å‡½æ•°ï¼ˆå¦‚ `katex.renderToString` æˆ– `katex.render`ï¼‰å°†è¿™äº› LaTeX ä»£ç è½¬æ¢ä¸º HTML æ ¼å¼ã€‚ChatGPT å¹¶ä¸æ‰§è¡Œè¿™äº›æ¸²æŸ“è¿‡ç¨‹ï¼Œè€Œåªæ˜¯æä¾›äº† LaTeX ä»£ç æœ¬èº«ã€‚



éœ€è¦ä½¿ç”¨æ­£åˆ™åŒ¹é…å¯¹åº”çš„å—çº§æ•°å­¦å…¬å¼å’Œè¡Œå†…æ•°å­¦å…¬å¼åˆ†åˆ«å¤„ç†

```vue
<template>
    <div ref="mathContainer" v-html="renderedContent"></div>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import katex from 'katex'
import { marked } from 'marked'

const props = defineProps<{
    content: string
}>()

// Function to render display math mode formulas
// æ¸²æŸ“å—çº§æ•°å­¦å…¬å¼
const renderDisplayMath = (content: string) => {
    return content.replace(/\\\[((.|\n)+?)\\\]/g, (match, formula) => {
        try {
            return katex.renderToString(formula, {
                displayMode: true,
                throwOnError: true
            })
        } catch (e) {
            console.error('KaTeX display math error:', e)
            return match
        }
    })
}

// Function to render inline math mode formulas
// æ¸²æŸ“è¡Œå†…æ•°å­¦å…¬å¼
const renderInlineMath = (content: string) => {
    return content.replace(/\\\((.+?)\\\)/g, (match, formula) => {
        try {
            const str = katex.renderToString(formula, {
                displayMode: false,
                throwOnError: true
            })
            return str
        } catch (e) {
            console.error('KaTeX inline math error:', e)
            return match
        }
    })
}

const renderedContent = computed(() => {
    let processed = renderDisplayMath(props.content)
    processed = renderInlineMath(processed)
    // Then process markdown
    processed = marked(processed)
    return processed
})
</script>
```

ä¸Šé¢æœ‰ä¸¤æ®µæ­£åˆ™åˆ†åˆ«æ˜¯ï¼š

1. `/\\\[((.|\n)+?)\\\]/g` è¿™æ¡æ­£åˆ™ç”¨æ¥åŒ¹é…å—çº§æ•°å­¦å…¬å¼ `\` å’Œ `\]`è¯­æ³•
1. `/\\\((.+?)\\\)/g` è¿™æ¡æ­£åˆ™ç”¨äºåŒ¹é…è¡Œå†…æ•°å­¦å…¬å¼ `\(` å’Œ `)\`

## å°è£…ä¸€ä¸ªå·¥å…·å‡½æ•°renderAllMath

```ts
export function renderAllMath(content: string) {
    if (!content) return content
    let processed = content
    // 1. æ¸²æŸ“ $$...$$ï¼ˆå—çº§ï¼‰
    processed = processed.replace(/\$\$([\s\S]+?)\$\$/g, (match, formula) => {
        try {
            return katex.renderToString(formula, {
                displayMode: true,
                throwOnError: false
            })
        } catch (e) {
            console.error('KaTeX $$...$$ Error:', e)
            return match
        }
    })
    // 2. æ¸²æŸ“ \[...\]ï¼ˆMathJax å—çº§é£æ ¼ï¼‰
    processed = processed.replace(/\\\[([\s\S]+?)\\\]/g, (match, formula) => {
        try {
            return katex.renderToString(formula, {
                displayMode: true,
                throwOnError: false
            })
        } catch (e) {
            console.error('KaTeX \\[...\\] Error:', e)
            return match
        }
    })
    // 3. æ¸²æŸ“ \(...\)ï¼ˆè¡Œå†…å…¬å¼ï¼‰
    processed = processed.replace(/\\\((.+?)\\\)/g, (match, formula) => {
        try {
            return katex.renderToString(formula, {
                displayMode: false,
                throwOnError: false
            })
        } catch (e) {
            console.error('KaTeX \\(...\\) Error:', e)
            return match
        }
    })
    return processed
}
```

è¯´æ˜ï¼š

æ­£åˆ™`/\\\[((.|\n)+?)\\\]/g`ç®€åŒ–ä¸º`/\\\[([\s\S]+?)\\\]/g`

- `[\s\S]` èƒ½åŒ¹é…ä»»æ„å­—ç¬¦ï¼ˆåŒ…æ‹¬æ¢è¡Œï¼‰ï¼Œæ¯” `(.|\n)` æ›´å¸¸è§







## @kangc/v-md-editorä¸­æ•°å­¦å…¬å¼æ¸²æŸ“

```ts
<v-md-preview :text="content" @copy-code-success="() => emit('copyCodeSuccess')" :height="height"></v-md-preview>

import VMdPreview from "@kangc/v-md-editor/lib/preview"
import createKatexPlugin from "@kangc/v-md-editor/lib/plugins/katex/npm"
VMdPreview.use(createKatexPlugin())
```

### å…³äºv-md-editorä¸­æ•°å­¦å…¬å¼æ¸²æŸ“ä¸å‡ºæ¥çš„é—®é¢˜

v-md-editorä¸èƒ½è¯†åˆ« `\[...\]` å’Œ `\(...\)` è¯­æ³•

è§£å†³åŠæ³•æ˜¯ä¸è¦ä½¿ç”¨v-md-editorè‡ªå¸¦çš„katexæ’ä»¶ï¼Œæ”¹æˆä½¿ç”¨è‡ªå®‰è£…çš„katex

å³v-md-editorç»„ä»¶ä¸è¦æ‰§è¡Œ`VMdPreview.use(createKatexPlugin())`

æœ€ç»ˆä¼ å…¥çš„contentéœ€è¦æ‰§è¡Œä»¥ä¸‹ä»£ç 

```ts
const renderContent = computed(() => {
    let processed = renderBlockMath(content)
    processed = renderInlineMath(processed)
    // Then process markdown
    return processed
})
```



## ç¼–å†™ä¸€ä¸ªKatex Markdownæ¸²æŸ“ç»„ä»¶

```vue
<template>
    <MdPreview :content="renderContent"></MdPreview>
</template>

<script setup lang="ts">
import MdPreview from '@/components/MdPreview/index.vue'
import { renderAllMath } from '@/app/utils/katex'
import 'katex/dist/katex.min.css'
import { computed } from 'vue'
const { content } = defineProps<{ content: string }>()

const renderContent = computed(() => {
    return renderAllMath(content)
})
</script>
```

**MdPreview.vue**

```vue
<template>
    <v-md-preview :text="content"></v-md-preview>
</template>

<script setup lang="ts">
import VMdPreview from '@kangc/v-md-editor/lib/preview'
import '@kangc/v-md-editor/lib/style/preview.css'
import githubTheme from '@kangc/v-md-editor/lib/theme/vuepress.js'
import '@kangc/v-md-editor/lib/theme/style/vuepress.css'
import createKatexPlugin from '@kangc/v-md-editor/lib/plugins/katex/npm'
// import markdownItKatex from '@vscode/markdown-it-katex'
// import vscodeKatexPlugin from './vscode-katex-plugin'


defineOptions({
    name: 'MdPreview'
})

interface MdPreviewProps {
    content: string
}

const { content } = defineProps<MdPreviewProps>()

VMdPreview.use(githubTheme, {})
VMdPreview.use(createKatexPlugin())
</script>
```

å…¶ä¸­æœ€å…³é”®çš„å°±æ˜¯**renderAllMath**å‡½æ•°çš„ä½¿ç”¨





## æ¸²æŸ“echarts

å¼•å…¥`@lexmin0412/markdown-it-echarts`

```ts
VMdPreview.use(githubTheme, {})
VMdPreview.use(createKatexPlugin())
VMdPreview.use(MarkdownItPluginEcharts)
```

ç»“æœå‘ç°æç¤ºindex.js:6 Uncaught (in promise) TypeError: Cannot read properties of undefined (reading 'rules')    at markdownItEcharts

åŸå› æ˜¯

> ä½ åœ¨ç»„ä»¶å†…éƒ¨ (`<script setup>`) é‡Œç›´æ¥å¯¹ `VMdPreview` è°ƒç”¨äº† `.use()`ï¼Œ
>  è¿™æ„å‘³ç€æ¯æ¬¡è¯¥ç»„ä»¶è¢«åŠ è½½æ—¶éƒ½ä¼šé‡å¤åˆå§‹åŒ–ä¸€æ¬¡æ’ä»¶ä½“ç³»ï¼Œè€Œè¿™æ—¶ markdown-it å®ä¾‹è¿˜æ²¡å‡†å¤‡å¥½ï¼Œ
>  å› æ­¤ `MarkdownItPluginEcharts` æ”¶åˆ°çš„ `md` æ˜¯ `undefined`ï¼Œå°±ä¼šæŠ¥ï¼š
>  `Cannot read properties of undefined (reading 'rules')`

ä¸ºé˜²æ­¢é‡å¤æ³¨å†Œï¼ŒæŠŠ `v-md-preview` çš„æ’ä»¶æ³¨å†Œï¼ˆä¸»é¢˜ã€echartsã€katexï¼‰**æŠ½ç¦»åˆ°ç‹¬ç«‹æ¨¡å—**ä¸­ï¼Œåªæ‰§è¡Œä¸€æ¬¡ã€‚
 ä¸è¦åœ¨ç»„ä»¶å†…è°ƒç”¨ `.use()`ã€‚

æ–°å»ºsrc/plugins/v-md-preview.ts

åœ¨main.tsä¸­æ³¨å†Œ

## VMdPreviewç»Ÿä¸€æ³¨å†Œ

```ts
import VMdPreview from '@kangc/v-md-editor/lib/preview'
import '@kangc/v-md-editor/lib/style/preview.css'

import githubTheme from '@kangc/v-md-editor/lib/theme/vuepress.js'
import '@kangc/v-md-editor/lib/theme/style/vuepress.css'

import createKatexPlugin from '@kangc/v-md-editor/lib/plugins/katex/npm'
import 'katex/dist/katex.min.css'

import MarkdownItPluginEcharts from '@lexmin0412/markdown-it-echarts'
import * as echarts from 'echarts'

console.group('v-md-previewåˆå§‹åŒ–')

VMdPreview.use(githubTheme, {
    extend(md: any) {
        md.use(MarkdownItPluginEcharts, { echarts })
    }
})
VMdPreview.use(createKatexPlugin())

export default VMdPreview
```

è¿›ä¸€æ­¥
`@kangc/v-md-editor` æä¾›ä¸¤å¤§æ ¸å¿ƒç»„ä»¶ï¼šv-md-editorå’Œv-md-preview

> ä¸¤è€…ä½¿ç”¨çš„åº•å±‚æ¸²æŸ“å¼•æ“æ˜¯ä¸€è‡´çš„ï¼Œéƒ½æ”¯æŒé€šè¿‡ `.use(plugin)` æ¥æ‰©å±• markdown-it æ’ä»¶ã€‚
>  æ‰€ä»¥æˆ‘ä»¬åªè¦å°è£…ä¸€ä»½é€šç”¨çš„â€œæ³¨å†Œé€»è¾‘â€ï¼Œè®© **Editor å’Œ Preview å…±ç”¨é…ç½®**ã€‚

```ts
import VMdPreview from '@kangc/v-md-editor/lib/preview'
import '@kangc/v-md-editor/lib/style/preview.css'

import VMdEditor from '@kangc/v-md-editor/lib/base-editor'
import '@kangc/v-md-editor/lib/style/base-editor.css'

import githubTheme from '@kangc/v-md-editor/lib/theme/vuepress.js'
import '@kangc/v-md-editor/lib/theme/style/vuepress.css'

import createKatexPlugin from '@kangc/v-md-editor/lib/plugins/katex/npm'
import 'katex/dist/katex.min.css'

import MarkdownItPluginEcharts from '@lexmin0412/markdown-it-echarts'
import * as echarts from 'echarts'

console.group('v-md-previewåˆå§‹åŒ–')

function setupVMd(instance: any) {
    instance.use(githubTheme, {
        extend(md: any) {
            md.use(MarkdownItPluginEcharts, { echarts })
        }
    })
    instance.use(createKatexPlugin())
}

setupVMd(VMdPreview)
setupVMd(VMdEditor)

export { VMdPreview, VMdEditor }
```



[ç¼–è¾‘å™¨å†…æ˜¾ç¤ºå…¬å¼æ—¶ï¼Œæ ¹å·é”™ä½æˆ–è€…ä¸æ˜¾ç¤ºé—®é¢˜çš„ä¿®å¤åŠæ³•](https://github.com/code-farmer-i/vue-markdown-editor/issues/317)

```
VMdEditor.xss.extend({
    whiteList: {
        svg: ['preserveaspectratio', 'viewbox', 'width', 'height'],
        path: ['d', 'fill', 'stroke', 'stroke-width'],
        rect: ['x', 'y', 'width', 'height', 'fill', 'stroke'],
        circle: ['cx', 'cy', 'r', 'fill', 'stroke'],
        g: ['transform']
    }
})
```



## ç»™v-md-previewç»„ä»¶æ·»åŠ é˜²æŠ–

åŸæœ¬ä»£ç 

```vue
<template>
    <v-md-preview :text="content"></v-md-preview>
</template>

<script setup lang="ts">
defineOptions({
    name: 'MdPreview'
})

interface MdPreviewProps {
    content: string
}

const { content } = defineProps<MdPreviewProps>()
</script>
```

ä½¿ç”¨refDebouncedæ·»åŠ é˜²æŠ–

```vue
<template>
  <v-md-preview :text="debounceValue" class="mermaid-preview"></v-md-preview>
</template>

<script setup lang="ts">
import { refDebounced } from '@vueuse/core'
import { toRef } from 'vue'

defineOptions({
  name: 'MdPreview'
})

interface MdPreviewProps {
  content: string
}

const props = defineProps<MdPreviewProps>()

const debounceValue = refDebounced(toRef(props, 'content'), 300)
</script>

<style scoped>
:deep(.mermaid-preview) {
  .v-md-mermaid {
    display: flex;
    justify-content: center;
    margin: 1em 0;
  }
}
</style>
```



## åœ¨@kangc/v-md-editorä¸­æ¸²æŸ“mermaidæµç¨‹å›¾

æŠ¥é”™ TypeError: Cannot read properties of undefined (reading 'languages') æ˜¯å› ä¸º VuePress ä¸»é¢˜åœ¨å°è¯•é€šè¿‡ Prism.languages æ£€æŸ¥ä»£ç è¯­è¨€ï¼ˆåŒ…æ‹¬ mermaidï¼‰æ—¶ï¼Œæ‰¾ä¸åˆ° Prism å®ä¾‹å¯¼è‡´çš„ã€‚

åœ¨ @kangc/v-md-editor ä¸­ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ VuePress ä¸»é¢˜ï¼ˆ@kangc/v-md-editor/lib/theme/vuepress.jsï¼‰ï¼Œå®ƒå†…éƒ¨ä¾èµ– Prism.js æ¥å¤„ç†ä»£ç å—çš„è§£æå’Œé«˜äº®ã€‚

```ts
// 1. å¿…é¡»å¼•å…¥ prismjs
import Prism from 'prismjs'
// å¦‚æœéœ€è¦å…¶ä»–è¯­è¨€é«˜äº®ï¼Œä¹Ÿå¯ä»¥åœ¨æ­¤å¼•å…¥
import 'prismjs/components/prism-json'
import 'prismjs/components/prism-bash'

// ... mermaid å¯¼å…¥
import createMermaidPlugin from '@kangc/v-md-editor/lib/plugins/mermaid/npm'
import '@kangc/v-md-editor/lib/plugins/mermaid/mermaid.css'
import mermaid from 'mermaid'


function setupVMd(instance: any) {
    instance.use(githubTheme, {
        // 2. å¿…é¡»å°† Prism ä¼ å…¥ä¸»é¢˜é…ç½®
        Prism,
        extend(md: any) {
            md.use(MarkdownItPluginEcharts, { echarts })
        }
    })
    instance.use(createKatexPlugin())
    // 3. æ³¨å†Œ mermaid æ’ä»¶
    instance.use(createMermaidPlugin({ mermaid }))
}
// ...
```

æµå¼è¾“å‡ºmermaidè¯­æ³•çš„é—®é¢˜

å½“æ¨¡å‹è¾“å‡ºäº† ```mermaid`ä½†è¿˜æ²¡è¾“å®Œé‡Œé¢çš„å†…å®¹ï¼ˆæ¯”å¦‚åªè¾“å‡ºäº†`grap` è€Œä¸æ˜¯ `graph TD`ï¼‰æ—¶ï¼Œ`v-md-editor` å·²ç»è§¦å‘äº†ç»„ä»¶æ›´æ–°ã€‚

Mermaid å°è¯•è§£æ `grap`ï¼Œå‘ç°æ˜¯ä¸åˆæ³•çš„è¯­æ³•ï¼Œäºæ˜¯æŠ›å‡º `UnknownDiagramError` å¹¶åœ¨é¡µé¢æ˜¾ç¤ºçº¢è‰²çš„ Syntax Errorã€‚

#### æ–¹æ¡ˆä¸€ï¼šåŠ¨æ€æ›¿æ¢æœªé—­åˆçš„ Mermaid æ ‡ç­¾ï¼ˆæ¨è ğŸŒŸï¼‰

è¿™æ˜¯æœ€ä¼˜é›…çš„æ–¹æ¡ˆã€‚æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ª Computed å±æ€§ï¼Œæ£€æµ‹ Markdown æ–‡æœ¬ã€‚å¦‚æœå‘ç°æœ‰ä¸€ä¸ª `mermaid` ä»£ç å—**æ²¡æœ‰é—­åˆ**ï¼ˆå³è¿˜æ²¡æœ‰è¾“å‡ºæœ€åçš„ ` `ï¼‰ï¼Œæˆ‘ä»¬å°±æš‚æ—¶æŠŠå®ƒæ›¿æ¢æˆ ````text` æˆ– ````loading`ã€‚

è¿™æ ·ï¼Œåœ¨æµå¼è¾“å‡ºçš„è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·çœ‹åˆ°çš„æ˜¯ä¸€æ®µæ™®é€šçš„æ–‡æœ¬ä»£ç å—ï¼›ä¸€æ—¦æ¨¡å‹è¾“å‡ºå®Œæ¯•ï¼ˆé—­åˆäº†ä»£ç å—ï¼‰ï¼Œå®ƒå°±ä¼šç¬é—´å˜æˆ Mermaid å›¾è¡¨ã€‚

å¤„ç†æœªé—­åˆçš„mermaidè¯­æ³•

```ts
// å¤„ç†æœªé—­åˆçš„ mermaid ä»£ç å—
const safeContent = computed(() => {
  const text = content.value
  // æ­£åˆ™åŒ¹é…æœªé—­åˆçš„ mermaid ä»£ç å—
  // åŒ¹é…è§„åˆ™ï¼šä»¥ ```mermaid å¼€å¤´ï¼Œä½†æ˜¯åé¢æ²¡æœ‰ ``` ç»“æŸçš„ä»£ç å—
  const mermaidRegex = /```mermaid([\s\S]*?)$/
  
  if (mermaidRegex.test(text)) {
    // æ£€æŸ¥æ˜¯å¦çœŸçš„æœªé—­åˆï¼ˆæ’é™¤å·²ç»æœ‰ç»“æŸç¬¦çš„æƒ…å†µï¼‰
    // æ³¨æ„ï¼šä¸Šé¢çš„æ­£åˆ™å·²ç»éšå«äº†"ä½äºæœ«å°¾"ä¸”"æœªé—­åˆ"çš„è¯­ä¹‰ï¼Œä½†ä¸ºäº†ä¿é™©ï¼Œ
    // æˆ‘ä»¬å†æ¬¡ç¡®è®¤è¯¥æ®µè½æ˜¯å¦ç¡®å®æ²¡æœ‰ç»“æŸæ ‡è®°
    const lastMermaidIndex = text.lastIndexOf('```mermaid')
    const lastCloseIndex = text.lastIndexOf('```', lastMermaidIndex + 10) // ä» mermaid åå¼€å§‹æ‰¾
    
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç»“æŸæ ‡è®°ï¼Œè¯´æ˜æœªé—­åˆ
    // æˆ–è€…æ‰¾åˆ°çš„ç»“æŸæ ‡è®°åœ¨ mermaid æ ‡è®°ä¹‹å‰ï¼ˆè¿™ç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿï¼Œå› ä¸º lastIndexOf æ˜¯ä»åå¾€å‰æ‰¾çš„ï¼Œ
    // ä½†å¦‚æœ text æ˜¯ ```mermaid ... ``` ... ```mermaid ... è¿™ç§ç»“æ„ï¼Œæˆ‘ä»¬éœ€è¦å°å¿ƒï¼‰
    // æ›´ç®€å•çš„é€»è¾‘ï¼šä»æœ€åä¸€ä¸ª ```mermaid å¼€å§‹æˆªå–ï¼Œçœ‹è¿™æ®µå­—ç¬¦ä¸²é‡Œæœ‰æ²¡æœ‰ ```
    const lastBlock = text.slice(lastMermaidIndex)
    if (!lastBlock.slice(10).includes('```')) {
      // æœªé—­åˆï¼Œå°†å…¶æ›¿æ¢ä¸º text ç±»å‹ï¼Œè¿™æ ·å°±ä¸ä¼šè§¦å‘ mermaid æ¸²æŸ“
      return text.slice(0, lastMermaidIndex) + '```text' + lastBlock.slice(10)
    }
  }
  return text
})
```

å°è£…hooks useSafeMermaid.ts

```ts
import { computed, type Ref } from 'vue'

/**
 * å¤„ç†æµå¼è¾“å‡ºä¸­çš„ Markdown å†…å®¹ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢ Mermaid åœ¨æœªé—­åˆæ—¶æ¸²æŸ“å¯¼è‡´æŠ¥é”™
 * @param content Ref<string> åŸå§‹ Markdown å†…å®¹
 * @returns Ref<string> å¤„ç†åçš„å®‰å…¨å†…å®¹
 */
export function useSafeMermaid(content: Ref<string>) {
  return computed(() => {
    const text = content.value
    // æ­£åˆ™åŒ¹é…æœªé—­åˆçš„ mermaid ä»£ç å—
    // åŒ¹é…è§„åˆ™ï¼šä»¥ ```mermaid å¼€å¤´ï¼Œä½†æ˜¯åé¢æ²¡æœ‰ ``` ç»“æŸçš„ä»£ç å—
    const mermaidRegex = /```mermaid([\s\S]*?)$/

    if (mermaidRegex.test(text)) {
      const lastMermaidIndex = text.lastIndexOf('```mermaid')
      // æ£€æŸ¥æœ€åä¸€æ®µæ˜¯å¦çœŸçš„æ²¡æœ‰é—­åˆ
      // ä» mermaid åå¼€å§‹æ‰¾
      const lastBlock = text.slice(lastMermaidIndex)

      // å¦‚æœè¿™ä¸€æ®µé‡Œæ²¡æœ‰ç»“æŸæ ‡è®° ``` (æ³¨æ„è¦æ’é™¤æ‰å¼€å¤´çš„ ```mermaid è¿™10ä¸ªå­—ç¬¦)
      if (!lastBlock.slice(10).includes('```')) {
        // æœªé—­åˆï¼Œå°†å…¶æ›¿æ¢ä¸º text ç±»å‹ï¼Œè¿™æ ·å°±ä¸ä¼šè§¦å‘ mermaid æ¸²æŸ“
        // è¿™é‡Œæ›¿æ¢ä¸º text æ˜¯ä¸ºäº†è®©ç”¨æˆ·çœ‹åˆ°åŸå§‹ä»£ç ï¼Œä¹Ÿå¯ä»¥æ›¿æ¢ä¸º loading ç­‰è‡ªå®šä¹‰å—
        return text.slice(0, lastMermaidIndex) + '```text' + lastBlock.slice(10)
      }
    }
    return text
  })
}
```



